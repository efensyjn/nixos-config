This file is a merged representation of a subset of the codebase, containing files not matching ignore patterns, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching these patterns are excluded: flake.lock
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
hosts/
  orrin/
    default.nix
    hardware-configuration.nix
    pkgs.nix
  waguri/
    default.nix
    hardware-configuration.nix
    pkgs.nix
lib/
  mksystem.nix
mods/
  desktops/
    hyprland.nix
    plasma.nix
  greeters/
    sddm.nix
  services/
    libinput.nix
    pipewire.nix
    xserver.nix
  specialization/
    hyprland.nix
  default.nix
  networking.nix
  nvidia.nix
secrets/
  cloudflared-creds.json
  efe.yaml
users/
  aly/
    default.nix
    home.nix
    programs.nix
  efe/
    orrin/
      default.nix
    waguri/
      default.nix
    aliases.nix
    default.nix
    home.nix
    programs.nix
.sops.yaml
flake.nix
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="hosts/orrin/hardware-configuration.nix">
# Do not modify this file!  It was generated by ‘nixos-generate-config’
# and may be overwritten by future invocations.  Please make changes
# to /etc/nixos/configuration.nix instead.
{ config, lib, pkgs, modulesPath, ... }:

{
  imports =
    [ (modulesPath + "/installer/scan/not-detected.nix")
    ];

  boot.initrd.availableKernelModules = [ "xhci_pci" "ahci" "sd_mod" "sdhci_pci" ];
  boot.initrd.kernelModules = [ ];
  boot.kernelModules = [ "kvm-intel" ];
  boot.extraModulePackages = [ ];

  fileSystems."/" =
    { device = "/dev/disk/by-uuid/c9a04e80-1f2c-45cd-a3cb-3a70a306ed7f";
      fsType = "ext4";
    };

  fileSystems."/boot" =
    { device = "/dev/disk/by-uuid/45E4-4411";
      fsType = "vfat";
      options = [ "fmask=0077" "dmask=0077" ];
    };

  swapDevices =
    [ { device = "/dev/disk/by-uuid/5a626ee6-675e-406a-899d-8ba8485a4fce"; }
    ];

  nixpkgs.hostPlatform = lib.mkDefault "x86_64-linux";
  hardware.cpu.intel.updateMicrocode = lib.mkDefault config.hardware.enableRedistributableFirmware;
}
</file>

<file path="hosts/orrin/pkgs.nix">
{ pkgs, ... }:

{
  environment.systemPackages = with pkgs; [

    ## ─── Utilities ───────────────────────────────
    p7zip
    docker-compose

    ## ─── Security & Passwords ────────────────────
    sops
    age

    ## ─── Libraries & Dependencies ─
    gnutls
    sqlite
    openssl
  ];
}
</file>

<file path="hosts/waguri/hardware-configuration.nix">
# Do not modify this file!  It was generated by ‘nixos-generate-config’
# and may be overwritten by future invocations.  Please make changes
# to /etc/nixos/configuration.nix instead.
{ config, lib, modulesPath, ... }:

{
  imports =
    [ (modulesPath + "/installer/scan/not-detected.nix")
    ];

  boot.initrd.availableKernelModules = [ "xhci_pci" "ahci" "nvme" "usb_storage" "usbhid" "sd_mod" ];
  boot.initrd.kernelModules = [ ];
  boot.kernelModules = [ "kvm-intel" ];
  boot.extraModulePackages = [ ];

  fileSystems."/" =
    { device = "/dev/disk/by-uuid/6bafe313-c88d-4c5a-b727-f93f835e8c06";
      fsType = "ext4";
    };

  fileSystems."/boot" =
    { device = "/dev/disk/by-uuid/9D56-32E9";
      fsType = "vfat";
      options = [ "fmask=0077" "dmask=0077" ];
    };

  swapDevices =
    [ { device = "/dev/disk/by-uuid/d07c1e6d-3d72-4236-8a4f-f4d2830c7751"; }
    ];

  # Enables DHCP on each ethernet and wireless interface. In case of scripted networking
  # (the default) this is the recommended approach. When using systemd-networkd it's
  # still possible to use this option, but it's recommended to use it in conjunction
  # with explicit per-interface declarations with `networking.interfaces.<interface>.useDHCP`.
  networking.useDHCP = lib.mkDefault true;
  # networking.interfaces.enp3s0.useDHCP = lib.mkDefault true;
  # networking.interfaces.wlp0s20f0u1.useDHCP = lib.mkDefault true;

  nixpkgs.hostPlatform = lib.mkDefault "x86_64-linux";
  hardware.cpu.intel.updateMicrocode = lib.mkDefault config.hardware.enableRedistributableFirmware; 
}
</file>

<file path="mods/desktops/hyprland.nix">
{ lib, config, ... }:

{
  imports = [
    ../greeters/sddm.nix
  ];

  options = {
    mods.hyprland = {
      enable = lib.mkOption {
        type = lib.types.bool;
        default = false;
        description = "Enable hyprland";
      };
    };
  };

  config = lib.mkIf config.mods.hyprland.enable {
    programs.hyprland = {
      enable = true;
      xwayland.enable = true;
    };
    mods.sddm.enable = true;
  };
}
</file>

<file path="mods/desktops/plasma.nix">
{ lib, config, pkgs, ... }:

{
  imports = [
    ../greeters/sddm.nix
  ];

  options = {
    mods.plasma = {
      enable = lib.mkOption {
        type = lib.types.bool;
        default = false;
        description = "Enable kde plasma 6";
      };
    };
  };

  config = lib.mkIf config.mods.plasma.enable {
    services.xserver.enable = true;
    services.desktopManager.plasma6.enable = true;
    mods.sddm.enable = true;
    environment.plasma6.excludePackages = with pkgs.kdePackages; [
      konsole
    ];
  };
}
</file>

<file path="mods/default.nix">
{ ... }:

{
  imports = [
    ./nvidia.nix
    ./networking.nix

    ./services/libinput.nix
    ./services/pipewire.nix
    ./services/xserver.nix

    ./desktops/hyprland.nix
    ./desktops/plasma.nix

    ./specialization/hyprland.nix
  ];
}
</file>

<file path="secrets/cloudflared-creds.json">
{
	"AccountTag": "ENC[AES256_GCM,data:AlZUomReCn/XVpj94ahBLCQ/aiSpOOphol3oVZskUiQ=,iv:dDBInaWF1ElNEsbL5sW0jw8rAlXTTyhhqWcmi2mg488=,tag:Iz2lw91NxC44UFJFRqdtRg==,type:str]",
	"TunnelSecret": "ENC[AES256_GCM,data:IYXkjdvc79JkwvkV0wLm/CcE0Hum35fHk58b812Ss7X72VVbpN6+iam6v6k=,iv:a+By2dUqrEq+g4FXPVYrzZbC1iCbFEeBrMU3/Kxq9O8=,tag:fceTkZIyCkByXF29kJDAMg==,type:str]",
	"TunnelID": "ENC[AES256_GCM,data:RIPdsvDIcRcaqWi4rwh9qknNDCFOFkZl3AzASVFGc+hPaE9g,iv:IICZTGCN7z9ElYQ7aqSn4Gycl+dH18JtL/0jljEJo/I=,tag:FYxAuqLnNlVrwYTAJa7lBA==,type:str]",
	"Endpoint": "",
	"sops": {
		"age": [
			{
				"recipient": "age1wxzjzk08tg0m6vafa7fzaxs37nsfer5alfjv64s00xy3jjh0h58qkek6mp",
				"enc": "-----BEGIN AGE ENCRYPTED FILE-----\nYWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBQc2hGY0xyalk2d3QxTFlU\nS0dDb09RUG5nL0ZMUm1qL3FqYnd6UDVabWxvCi83eXhqWFlFVnY5dTY0T0cxcDJl\nNkQ1NjF2QlA4Y3ZQRE1GYW5jWWVhejQKLS0tIGxveUVUNmZBK0sxNGVxaFRtSE83\nNGhiWURScWVoSnhMZEZjaG92NzJMdzgKDqGiyi6yEp9vAJAx8+2m5xjPVDsGd//s\ngH2z17yj7C/jc3VWrLZRXPZSXy7bjLA6JKWTeKBB6DQxWTwigJ8/OQ==\n-----END AGE ENCRYPTED FILE-----\n"
			}
		],
		"lastmodified": "2025-09-25T11:31:33Z",
		"mac": "ENC[AES256_GCM,data:cKo0VFPIshCxuwKvadR6kJSw+87oa2sUYOphiCvWeejJg5i8nEn7248IX+B0fEZNC/EFaiyB/xgAQi9uzoniy8+p4/pKLQjGQnirxGxu5wZ60wnf+aNBtaI2wUugGylYsHsPMNlqW57Gx20qJrBS2wH2HgjITwbRYixrarawlBA=,iv:FSwLUikKBoioO8xfxOSXgBaRverdje2vhWyH2bgbPGA=,tag:jPOt4hvXGocWqlIt3dxLCw==,type:str]",
		"unencrypted_suffix": "_unencrypted",
		"version": "3.10.2"
	}
}
</file>

<file path="users/aly/default.nix">
{ pkgs, config, ... }:

{
  sops.defaultSopsFile = ../../secrets/efe.yaml;
  sops.age.keyFile = "/var/lib/sops-nix/ghe.txt";

  sops.secrets."aly/hashedPassword" = {
    owner = "efe";
    neededForUsers = true;
  };

  users.users.aly = {
    isNormalUser = true;
    home = "/home/aly";
    shell = pkgs.zsh;

    ## ─── Groups ─────────────────────────────────
    extraGroups = [
      "wheel"    # sudo/admin
    ];

    ## ─── Authentication ─────────────────────────
    hashedPasswordFile = config.sops.secrets."aly/hashedPassword".path;
  };
}
</file>

<file path="users/aly/home.nix">
{ pkgs, ... }@e:

let
  hostname = e.hname;
in
{
  ## ─── Imports ──────────────────────────────────
  imports = [
    ./programs.nix
    #./${hostname}
  ];

  ## ─── Home Config ──────────────────────────────
  home.username = "aly";
  home.homeDirectory = "/home/aly";
  home.stateVersion = "25.05";

  ## ─── Core Services ────────────────────────────
  programs.home-manager.enable = true;
  xdg.enable = true;

  ## ─── Packages ─────────────────────────────────
  home.packages = with pkgs; [
    # Utilities
    p7zip
    gnupg
    sops
    age
  ];
}
</file>

<file path="users/efe/orrin/default.nix">
{ ... }:

{

}
</file>

<file path="users/efe/aliases.nix">
{ ... }:

 {
  home.shellAliases = {
    l = "eza -lah";
    ls = "eza";
    tree = "eza --tree --git-ignore";

    cat = "bat";
    man = "batman";
  };
 }
</file>

<file path=".sops.yaml">
keys:
  - &efe age1wxzjzk08tg0m6vafa7fzaxs37nsfer5alfjv64s00xy3jjh0h58qkek6mp
creation_rules:
  - path_regex: secrets/[^/]+\.(yaml|json|env|ini)$
    key_groups:
    - age:
      - *efe
</file>

<file path="mods/greeters/sddm.nix">
{ config, lib, ... }:

{
  options = {
    mods.sddm = {
      enable = lib.mkOption {
        type = lib.types.bool;
        default = false;
        description = "Enable sddm";
      };
    };
  };

  config = lib.mkIf config.mods.sddm.enable {  
    services.displayManager.sddm.enable = true;
    services.displayManager.sddm.wayland.enable = true;
  };
}
</file>

<file path="mods/services/libinput.nix">
{ config, lib, ... }:

{
  options = {
    mods.libinput = {
      enable = lib.mkOption {
        type = lib.types.bool;
        default = false;
        description = "Enable libinput";
      };
    };
  };

  config = {  
    services.libinput = {
      enable = lib.mkIf config.mods.libinput.enable true;
      mouse = {
        accelProfile = "flat";
      };
    };
  };
}
</file>

<file path="mods/services/pipewire.nix">
{ config, lib, ... }:

{
  options = {
    mods.pipewire = {
      enable = lib.mkOption {
        type = lib.types.bool;
        default = false;
        description = "Enable pipewire";
      };
    };
  };

  config = lib.mkIf config.mods.pipewire.enable {  
    services.pulseaudio.enable = false;
    security.rtkit.enable = true;
    services.pipewire = {
      enable = true;
      alsa.enable = true;
      alsa.support32Bit = true;
      pulse.enable = true;
      # If you want to use JACK applications, uncomment this
      #jack.enable = true;

      # use the example session manager (no others are packaged yet so this is enabled by default,
      # no need to redefine it in your config for now)
      #media-session.enable = true;
    };
  };
}
</file>

<file path="mods/services/xserver.nix">
{ config, lib, ... }:

{
  options = {
    mods.xserver = {
      enable = lib.mkOption {
        type = lib.types.bool;
        default = false;
        description = "Enable xserver";
      };
    };
  };

  config = {  
    services.xserver = {
      enable = lib.mkIf config.mods.xserver.enable true;
    };
  };
}
</file>

<file path="mods/specialization/hyprland.nix">
{ config, lib, ... }:

{
  imports = [
    ../desktops/hyprland.nix
    ../desktops/plasma.nix
  ];

  options = {
    mods.specialization.hyprland = {
      enable = lib.mkOption {
        type = lib.types.bool;
        default = false;
        description = "Enable hyprland specialization";
      };
    };
  };

  config = lib.mkIf config.mods.specialization.hyprland.enable {  
    specialisation.hyprland.configuration = {
      mods.hyprland.enable = true;
      mods.plasma.enable = lib.mkForce false;
    };
  };

}
</file>

<file path="users/aly/programs.nix">
{ inputs, ... }:

{

  imports = [
    inputs.nix4nvchad.homeManagerModule
  ];

  programs.nvchad.enable = true;
  
}
</file>

<file path="mods/networking.nix">
{ lib, config, ... }:

{
  options = {
    mods.networking = {
      enable = lib.mkOption {
        type = lib.types.bool;
        default = false;
        description = "Enable networking";
      };
    };
  };

  config = lib.mkIf config.mods.networking.enable {
    networking.networkmanager.enable = true;
    services.dnscrypt-proxy = {
      enable = true;
      settings = {
        server_names = [ "cloudflare" "quad9-dnscrypt-ip4-filter-pri" ];
        ipv6_servers = false;
        dnscrypt_servers = true;
        doh_servers = true;
      };
    };
    networking.nameservers = [ "127.0.0.1" ];
  };

}
</file>

<file path="mods/nvidia.nix">
{ config, lib, ... }:

let
  nvidiaPackage = config.hardware.nvidia.package;
in
{
  options = {
    mods.nvidia = {
      enable = lib.mkOption {
        type = lib.types.bool;
        default = false;
        description = "Enable nvidia settings";
      };
    };
  };

  config = lib.mkIf config.mods.nvidia.enable { 
    hardware.graphics = {
      enable = true;
    };

    hardware.nvidia = {

      # Modesetting is required.
      modesetting.enable = true;

      # Nvidia power management. Experimental, and can cause sleep/suspend to fail.
      # Enable this if you have graphical corruption issues or application crashes after waking
      # up from sleep. This fixes it by saving the entire VRAM memory to /tmp/ instead 
      # of just the bare essentials.
      powerManagement.enable = false;

      # Fine-grained power managemenlibinputt. Turns off GPU when not in use.
      # Experimental and only works on modern Nvidia GPUs (Turing or newer).
      powerManagement.finegrained = false;

      # Use the NVidia open source kernel module (not to be confused with the
      # independent third-party "nouveau" open source driver).
      # Support is limited to the Turing and later architectures. Full list of 
      # supported GPUs is at: 
      # https://github.com/NVIDIA/open-gpu-kernel-modules#compatible-gpus 
      # Only available from driver 515.43.04+
      open = true;

      # Enable the Nvidia settings menu,
      # accessible via `nvidia-settings`.
      nvidiaSettings = true;

      # Optionally, you may need to select the appropriate driver version for your specific GPU.
      package = config.boot.kernelPackages.nvidiaPackages.stable;
    };
    services.xserver.videoDrivers = ["nvidia"];
  };
}
</file>

<file path="secrets/efe.yaml">
user:
    hashedPassword: ENC[AES256_GCM,data:9FbX6/kD+PbU0iNltOWZm6K9tLDHwv5usxWaAmgaFfHTWhQvos2ftofuJVkzMtwbKdM3xzoRcrv9Wbp/Yen5ELbIemMlq07Ri+kMzLSCTJVSIP+wMuPLjyRd1WlqXNUX4grN4d3yZWHUvA==,iv:gcCG6qAK1N0jWphC0pem2o37Ze0Yo58hFKwpPNPpgtg=,tag:sylIO8tFqgp9IY/YK9fZ/g==,type:str]
aly:
    hashedPassword: ENC[AES256_GCM,data:KwN0sy+kIklkYpqQhKRftbxIFm8gVRnautJdo7e7GxgLkCisNS3QLlPAIJWN5PNhiopl0PM7EVydBqGYBgo/K6spBQhuVLryuZ/xnWpwid595E4r1mVmTXasbr2600yS693KA+X9iJOzlQ==,iv:LFRBNPJ5ZOFDEw4OoqrbbIJZUVsVQF1dUNUh+LzvC3Y=,tag:F4ccV5T/VXkkajeg9lFAiA==,type:str]
sops:
    age:
        - recipient: age1wxzjzk08tg0m6vafa7fzaxs37nsfer5alfjv64s00xy3jjh0h58qkek6mp
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBVQTZrR0p6U1o4cTF3TG5t
            L0ZSUnk4aTRyWmtrT0EwZXVUYTFDWk9lcVZzCmFUWEtzbjVLeHBTQ2xnU0VOekJt
            OEZOZjBjcFZDZ2RySnI1MGpRbmRWQXcKLS0tIFdWUCs4UUJrWU1rYkM3cEpiVDVw
            YlZqczc0V3k0Z29pcG9GaFk4RG9LMjAKXgzUIKOuBl6HVVIs2v2yucneCQIjOOuJ
            NGMeWkf4Fe0d6lV1OtTO/jZzxcfChlSvZT1XLC4BXf0zQaTNiIQSkA==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2025-09-12T09:52:30Z"
    mac: ENC[AES256_GCM,data:fCkpUpUqM/TS0y5eOODofMm7ImFbMCQxLvlkvYoa6j8QCOBx9o05TK7tHqpkpVRsLKfdCm1y1E/cxSplXpdwSoueoK/IpDW9SNS9yBcMLz6ttdVGddQNQ06XIMAcUy2N5wBdkpAC2KUaQJCdWBNMNhwMjniAxwjExZ+j3mTHa6U=,iv:o3oGW15tMLh94093Fvb3eWtVsUPJ6xx8p+Uuy2XO7+c=,tag:eMFwwG3zDnbHWI8jV2lHPg==,type:str]
    unencrypted_suffix: _unencrypted
    version: 3.10.2
</file>

<file path="hosts/orrin/default.nix">
{ config, ... }:

{
  imports = [
    ../../mods
  ];

  sops.age.keyFile = "/var/lib/sops-nix/ghe.txt";

  sops.secrets.cloudflared-creds = {
    sopsFile = ../../secrets/cloudflared-creds.json;
    format = "json";
    key = "";
  };

  services.automatic-timezoned.enable = true;
  nix.settings.experimental-features = [ "nix-command" "flakes" ];

  # ─── Bootloader ──────────────────────────────────────
  boot.loader.systemd-boot.enable = true;
  boot.loader.efi.canTouchEfiVariables = true;

  # ─── Programs ────────────────────────────────────────
  programs = {
    # Editors
    neovim = {
      enable = true;
      defaultEditor = true;
      viAlias = true;
      vimAlias = true;
    };

    # Development tools
    git.enable = true;
    nh.enable = true;

    # Shells
    zsh.enable = true;
  };

  # ─── Mods ────────────────────────────────────────────
  mods = {
    networking.enable = true;
  };

  networking.networkmanager.unmanaged = [ "wlp2s0" ];

  # ─── Virtualisation ──────────────────────────────────
  virtualisation.docker.enable = true;

  services.openssh = {
    enable = true;
  };

  services.cloudflared = {
    enable = true;
    tunnels = {
      "8fc7be20-3956-41a2-ab88-2ece7658e349" = {
        credentialsFile = "${config.sops.secrets.cloudflared-creds.path}";
        default = "http_status:404";
      };
    };
  };

  system.stateVersion = "25.05";
}
</file>

<file path="users/efe/waguri/default.nix">
{ pkgs, ... }:

{

  services.dunst = {
    enable = true;
  };

  programs.obs-studio = {
    enable = true;
    plugins = with pkgs.obs-studio-plugins; [
      wlrobs
      obs-backgroundremoval
      obs-pipewire-audio-capture
    ];
  };

  programs.mpv = {
    enable = true; 
    config = {
      gpu-api = "opengl";     # Force OpenGL instead of Vulkan
      hwdec = "auto-safe";    # Optional: safer hardware decoding
    };
  };

}
</file>

<file path="users/efe/programs.nix">
{ inputs, config, pkgs, ... }:

{
  ## ─── Imports ──────────────────────────────────
  imports = [
    inputs.nix4nvchad.homeManagerModule
    inputs.seanime.nixosModules.seanime
  ];

  ## ─── Editors & Development ────────────────────
  programs.nvchad.enable = true;
  programs.tmux.enable = true;

  programs.git = {
    enable = true;
    userEmail = "me@efensyjn.moe";
    userName = "efensyjn";
  };

  ## ─── Terminal ─────────────────────────────────
  programs.kitty = {
    enable = true;
    settings = {
      remember_window_position = false;
      initial_window_width = 640;
      initial_window_height = 400;

      confirm_os_window_close = 0;
      dynamic_background_opacity = false;
      enable_audio_bell = false;
      mouse_hide_wait = "-1.0";
      window_padding_width = 5;

      background_opacity = "0.95";
      background_blur = 1;
    };
  };

  ## ─── Shell ────────────────────────────────────
  programs.zsh = {
    enable = true;
    autosuggestion.enable = true;
    syntaxHighlighting.enable = true;
    
    history = {
      size = 10000;
      path = "${config.xdg.dataHome}/zsh/history";
    };

#    initContent = ''
#      unset SSH_AGENT_PID
#      if [ "''${gnupg_SSH_AUTH_SOCK_by:-0}" -ne $$ ]; then
#        export SSH_AUTH_SOCK="$(gpgconf --list-dirs agent-ssh-socket)"
#      fi
#      export GPG_TTY=$(tty)
#      gpg-connect-agent updatestartuptty /bye >/dev/null
#    '';

    oh-my-zsh = {
      enable = true;
      theme = "robbyrussell";
    };
  };

  programs.bat = {
    enable = true;
    extraPackages = with pkgs.bat-extras; [
      batdiff
      batman
      prettybat
    ];
  };

  programs.yazi.enable = true;
  modules.home.services.seanime.enable = true;
}
</file>

<file path="users/efe/default.nix">
{ pkgs, config, ... }:

{
  sops.defaultSopsFile = ../../secrets/efe.yaml;
  sops.age.keyFile = "/var/lib/sops-nix/ghe.txt";

  sops.secrets."user/hashedPassword" = {
    owner = "efe";
    neededForUsers = true;
  };

  users.users.efe = {
    isNormalUser = true;
    home = "/home/efe";
    shell = pkgs.zsh;

    ## ─── Groups ─────────────────────────────────
    extraGroups = [
      "wheel"    # sudo/admin
      "plugdev"  # device access
      "docker"
    ];

    openssh.authorizedKeys.keys = 
      [ "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIG/TuG97qualVQ1k9I4IXfafiChp8iOhfebl78MIMwZJ efe@waguri" ];

    ## ─── Authentication ─────────────────────────
    hashedPasswordFile = config.sops.secrets."user/hashedPassword".path;
  };
}
</file>

<file path="users/efe/home.nix">
{ pkgs, ... }@e:

let
  hostname = e.hname;
in
{
  ## ─── Imports ──────────────────────────────────
  imports = [
    ./programs.nix
    ./aliases.nix
    ./${hostname}
  ];

  ## ─── Home Config ──────────────────────────────
  home.username = "efe";
  home.homeDirectory = "/home/efe";
  home.stateVersion = "25.05";

  ## ─── Core Services ────────────────────────────
  programs.home-manager.enable = true;
  xdg.enable = true;

  ## ─── Packages ─────────────────────────────────
  home.packages = with pkgs; [
    # Utilities
    p7zip
    gnupg
    sops
    age
    eza
  ];
}
</file>

<file path="lib/mksystem.nix">
# edited from https://github.com/mitchellh/nixos-config

{ nixpkgs, overlays, inputs }:

name:
{
  system,
  users ? null,
  user ? null,
  unfree ? true
}:

let

  normalizedUsers =
    if users != null then users
    else if user != null then [ user ]
    else throw "Must provide either `user` or `users`.";

  hConf = ../hosts/${name};

  systemFunc = nixpkgs.lib.nixosSystem;
  home-manager = inputs.home-manager.nixosModules;

  hmUsers =
    builtins.listToAttrs (map (u: {
      name = u;
      value = import ../users/${u}/home.nix;
    }) normalizedUsers);
  userConfigs = map (u: ../users/${u}) normalizedUsers;

  pkp = ../hosts/${name}/pkgs.nix;
  pkg =
    if builtins.pathExists pkp
    then pkp
    else {};
  
  hname = name;

in systemFunc {
  inherit system;

  modules = [
    ../hosts/${name}/hardware-configuration.nix
    inputs.sops-nix.nixosModules.sops
    inputs.nix-dokploy.nixosModules.default
    inputs.aagl.nixosModules.default
    { nix.settings = inputs.aagl.nixConfig; }
    { nixpkgs.overlays = overlays; }
    { nixpkgs.config.allowUnfree = unfree; }
    { networking.hostName = name; }
    hConf
    pkg
    ]
    ++ userConfigs
    ++ [
      home-manager.home-manager {
        home-manager.useGlobalPkgs = true;
        home-manager.useUserPackages = true;
        home-manager.users = hmUsers;
        home-manager.extraSpecialArgs = { inherit inputs hname; };
      }
    ]
    ++ 
    [
      {
        _module.args = {
          inherit inputs;
          pkgs-stable = import inputs.nixpkgs-stable { 
            inherit system;
            config.allowUnfree = unfree;
          };
        };
      }
    ];
}
</file>

<file path="flake.nix">
{
  description = "Hermit in the mountains with a meticulously organized library of spells.";

  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs/nixos-unstable";
    nixpkgs-stable.url = "github:NixOS/nixpkgs/nixos-25.05";

    home-manager = {
      url = "github:nix-community/home-manager";
      inputs.nixpkgs.follows = "nixpkgs";
    };

    nix4nvchad = {
      url = "github:nix-community/nix4nvchad";
      inputs.nixpkgs.follows = "nixpkgs";
    };

    sops-nix = {
      url = "github:Mic92/sops-nix";
      inputs.nixpkgs.follows = "nixpkgs";
    };

    aagl = {
      url = "github:ezKEa/aagl-gtk-on-nix";
      inputs.nixpkgs.follows = "nixpkgs";
    };

    nix-dokploy.url = "github:el-kurto/nix-dokploy";
    
    seanime.url = "github:rishabh5321/seanime-flake";

  };

  outputs = { self, nixpkgs, home-manager, ... } @inputs: let
    overlays = [
      (final: prev: {
        nvchad = inputs.nix4nvchad.packages."${nixpkgs.system}".nvchad;
      })
    ];

    mkSystem = import ./lib/mksystem.nix {
      inherit overlays nixpkgs inputs;
    };
  in {
    nixosConfigurations = { 
      waguri = mkSystem "waguri" {
        system = "x86_64-linux";
        user = "efe";
      };
      orrin = mkSystem "orrin" {
        system = "x86_64-linux";
        users = [ "efe" "aly" ];
      };
    };
  };
}
</file>

<file path="hosts/waguri/default.nix">
{ ... }:

{
  imports = [
    ../../mods
  ];

  services.automatic-timezoned.enable = true;
  nix.settings.experimental-features = [ "nix-command" "flakes" ];

  # ─── Bootloader ──────────────────────────────────────
  boot.loader.systemd-boot.enable = true;
  boot.loader.efi.canTouchEfiVariables = true;

  # ─── Programs ────────────────────────────────────────
  programs = {
    # Browsers
    firefox.enable = true;

    # Editors
    neovim = {
      enable = true;
      defaultEditor = true;
      viAlias = true;
      vimAlias = true;
    };

    # Development tools
    git.enable = true;
    nh.enable = true;

    # Gaming
    steam = {
      enable = true;
      remotePlay.openFirewall = true;
      dedicatedServer.openFirewall = true;
    };
    gamemode.enable = true;

    # Shells
    zsh.enable = true;

    thunderbird.enable = true;

    anime-game-launcher.enable = true;
  };

  # ─── Services ────────────────────────────────────────
  services = {
    flatpak.enable = true;

    udev.extraRules = ''
      KERNEL=="hidraw*", SUBSYSTEM=="hidraw", ATTRS{idVendor}=="3554", ATTRS{idProduct}=="f58f", MODE="0666"
      KERNEL=="hidraw*", SUBSYSTEM=="hidraw", ATTRS{idVendor}=="373b", ATTRS{idProduct}=="1085", MODE="0666"
    '';

    hardware.openrgb = {
      enable = true;
      motherboard = "intel";
    };

    ## Vibe coding
    ollama.enable = true;
    ollama.acceleration = "cuda";
    
    qbittorrent.enable = true;

    n8n.enable = true;
  };

  # ─── Hardware ────────────────────────────────────────
  hardware.opentabletdriver.enable = true;

  # ─── Mods ────────────────────────────────────────────
  mods = {
    nvidia.enable = true;
    networking.enable = true;

    libinput.enable = true;
    pipewire.enable = true;
    xserver.enable = true;

    plasma.enable = true;
    specialization.hyprland.enable = true;
  };

  # ─── Virtualisation ──────────────────────────────────
  virtualisation.docker.enable = true;
  hardware.nvidia-container-toolkit.enable = true;
  virtualisation.waydroid.enable = true;
  # virtualisation.virtualbox.host.enable = true;
  # virtualisation.virtualbox.host.enableExtensionPack = true;
  users.extraGroups.vboxusers.members = [ "efe" ];

  system.stateVersion = "25.05";
}
</file>

<file path="hosts/waguri/pkgs.nix">
{ pkgs-stable, pkgs, ... }:

{
  environment.systemPackages = with pkgs; [

    ## ─── Utilities ───────────────────────────────
    p7zip
    docker-compose
    vscodium
    kdePackages.kate
    krita
    planify
    eza
    cloudflared

    ## ─── Communication & Media ───────────────────
    discord-ptb
    spotify
    brave
    exiftool

    ## ─── Security & Passwords ────────────────────
    cryptomator
    keepassxc
    kdePackages.kleopatra
    sops
    age

    ## ─── Gaming & Emulation ──────────────────────
    steam-run
    protonup-qt
    lutris
    prismlauncher
    rpcs3
    osu-lazer
    vinegar

    ## ─── Gaming Tools / Performance ──────────────
    dxvk
    mangohud
    meson
    pkgsi686Linux.gperftools   # required for CS:Source

    ## ─── Libraries & Dependencies ─
    libgpg-error
    libxml2
    freetype
    gnutls
    openldap
    SDL2
    sqlite
    xml2
    vulkan-tools

    wine64
    winetricks
    protontricks

    indi-with-drivers

    libreoffice-qt
    hunspell
    hunspellDicts.uk_UA
    hunspellDicts.th_TH

    # Vibe coding
    aider-chat-full

    uv
    python313

    direnv
    jetbrains.jdk-no-jcef
    jdk21
    libGL

    masscan
    libpcap

    unityhub

    kdePackages.kdenlive

    qbittorrent
    
    ffmpeg-full
    n8n
  ] ++ [
    pkgs-stable.lutris
    pkgs-stable.planify
    pkgs-stable.jetbrains.idea-community
    pkgs-stable.swiftshader
    pkgs-stable.kstars
  ];

  nixpkgs.config.permittedInsecurePackages = [
    "libsoup-2.74.3"
    "electron-35.7.5"
  ];
}
</file>

</files>
